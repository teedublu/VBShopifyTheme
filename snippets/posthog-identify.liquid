<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Ensure PostHog is loaded
    if (typeof window.posthog !== "undefined") {
      console.log("PostHog is already loaded. Identifying user...");

      // Identify Shopify User by Email or Customer ID
      var customerEmail = "{{ customer.email | json }}";
      var customerId = "{{ customer.id | json }}";

      if (customerEmail) {
        // Identify by Email (Preferred)
        posthog.identify(customerEmail);
        posthog.people.set({
          email: customerEmail,
          name: "{{ customer.first_name | json }} {{ customer.last_name | json }}"
        });
        posthog.people.set_once({
          first_purchase_date: "{{ customer.created_at | date: '%Y-%m-%d' }}"
        });
        console.log("User identified by email:", customerEmail);
      } else if (customerId) {
        // Fallback: Identify by Shopify Customer ID (Prefixed)
        posthog.identify("shopify-" + customerId);
        console.log("User identified by Shopify Customer ID:", customerId);
      } else {
        // Automatically use Anonymous ID (Handled by PixieHog)
        console.warn("User is anonymous. Default anonymous tracking in PostHog.");
      }
    } else {
      console.error("PostHog not loaded. User identification skipped.");
    }
  });
</script>
